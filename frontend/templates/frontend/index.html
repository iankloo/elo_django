<!DOCTYPE html>

{% load static %}

<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="shortcut icon" type="image/png" href="{% static 'frontend/img/favicon.ico' %}"/>
    <title>Elo Peer Rater</title>
  </head>

  <body>

  <style>

    .navbar-brand{
      padding-left:20px;
    }

    .content {
      margin-left: 15%;
      margin-right: 15%;
      margin-top: 20px
    }

    .input-group {
      /*margin-top: 20px;*/
      width: 100%;
      max-width: 350px;
    }

    .form-control {
      box-shadow: none!important;
    }

    .form-control:focus {
      border-color: #545b62 !important;
    }

    .card-img-top { cursor: pointer; border: solid 2px transparent; }
    .card-img-top:hover {border-color: black;}

    .card-body { cursor: pointer; }
    .card-body:hover {background: #f0f0f0;}

    #spec_col{
      max-width: 51%;
    }



    #overlay {
      background: #ffffff;
      color: #666666;
      position: fixed;
      height: 100%;
      width: 100%;
      z-index: 5000;
      top: 0;
      left: 0;
      float: left;
      text-align: center;
      padding-top: 25%;
      opacity: .80;
    }
    .spinner {
        margin: 0 auto;
        height: 64px;
        width: 64px;
        animation: rotate 0.8s infinite linear;
        border: 5px solid firebrick;
        border-right-color: transparent;
        border-radius: 50%;
    }
    @keyframes rotate {
        0% {
            transform: rotate(0deg);
        }
        100% {
            transform: rotate(360deg);
        }
    }

/*form {
  margin-left: 10%;
  margin-right: 10%;
}*/

form .statement {
  display:block;
  font-size: 1em;
  font-weight: bold;
  /*padding: 30px 0 0 4.25%;*/
  /*margin-bottom:10px;*/
}
form .likert {
  list-style:none;
  /*width:100%;*/
  margin:0;
  padding:0 0 20px;
  display:block;
  border-bottom:2px solid #efefef;
}
form .likert:last-of-type {border-bottom:0;}
form .likert:before {
  content: '';
  position:relative;
  top:11px;
  left:9.5%;
  display:block;
  background-color:#efefef;
  height:4px;
  width:78%;
}
form .likert li {
  display:inline-block;
  width:19%;
  text-align:center;
  vertical-align: top;
}
form .likert li input[type=radio] {
  display:block;
  position:relative;
  top:0;
  left:50%;
  margin-left:-6px;

}
form .likert li label {width:100%;}



h2{
  font-size: max(2vw, 25px) !important;
}

h3{
  font-size: max(1.5vw, 20px) !important;
}

h4{
  font-size: max(1.5vw, 18px) !important;
}

h5{
  font-size: max(1vw, 14px) !important;
}

.select2-container--bootstrap{
  display: inline-block !important;
}

/*.likert {
  font-size: .5em;
}*/

@media (max-width: 600px) {
  /* CSS that should be displayed if width is equal to or less than 800px goes here */
  .content {
    margin-left: 5%;
    margin-right: 5%;
    margin-top: 10px
  }

  @media (max-width: 600px) {
    .likert {
      font-size: .8em;
    }
  }
}

.navbar-right{
  position: fixed;
  top: 15px;
  right: 50px;/*pixels away from the right of the navbar*/
  color: #fff;
}

.navbar-right:hover{
  color: #fff;
  font-weight:bold;
  text-decoration: none !important;
}

.form-group.required .control-label:after {
    color: #d00;
    content: "*";
    position: absolute;
    margin-left: 4px;
    top:0px;
}

.table th, td {
  text-align: center !important;
}

.btn-sm {
  height: 2.35em;
  font-size: .65rem !important;
  text-align: center !important;
}


.dataTables_wrapper { font-size: .9em }

.dataTables_paginate>span>a {
    margin-bottom: 0px !important;
    padding: 1px 5px !important;
}

.dataTables_paginate>a {
    margin-bottom: 0px !important;
    padding: 1px 5px !important;
}

#exp_modal>.modal-dialog {
  max-width: 750px;
}

#view_exp_modal>.modal-dialog {
  max-width: 750px;
}

.search-input{
  width: 100%;
}

.custom-header{
  background: #6f757b;
  color: #fff;
}

  </style>



<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

<script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js" integrity="sha384-vFJXuSJphROIrBnz7yo7oB41mKfc8JzQZiCq4NCceLEaO4IHwicKwpJf9c9IpFgh" crossorigin="anonymous"></script>


<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>


<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.12/css/bootstrap-select.css">

<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/js/select2.min.js"></script>

<link href="https://cdnjs.cloudflare.com/ajax/libs/select2-bootstrap-theme/0.1.0-beta.10/select2-bootstrap.min.css" rel="stylesheet" />

<!--data.table-->
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.12.1/css/jquery.dataTables.css">
<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.12.1/js/jquery.dataTables.js"></script>


<!--icons-->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.3/font/bootstrap-icons.css">


<!--multiselect-->
<link rel="stylesheet" href="{% static 'frontend/css/multi-select.css' %}"/>
<script type="text/javascript" charset="utf8" src="{% static 'frontend/js/jquery.multi-select.js' %}"></script>
<script type="text/javascript" charset="utf8" src="{% static 'frontend/js/jquery.quicksearch.js' %}"></script>

<!--export buttons for table-->
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.2.3/css/buttons.dataTables.min.css"/>
<script type="text/javascript" src="https://cdn.datatables.net/buttons/1.3.1/js/dataTables.buttons.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/buttons/1.3.1/js/buttons.html5.min.js"></script>



  <nav class="navbar navbar-expand-sm bg-dark navbar-dark">
    <a class="navbar-brand" href="/">Elo Peer Rater</a>
    <a class="navbar-item navbar-right" id="login_toggle" href="#">Admin Login</a>
  </nav>

  <div class = 'main'></div>




<script>
  if (!String.prototype.format) {
    String.prototype.format = function() {
      var args = arguments;
      return this.replace(/{(\d+)}/g, function(match, number) { 
        return typeof args[number] != 'undefined'
          ? args[number]
          : match
        ;
      });
    };
  }

  $.fn.select2.defaults.set( "theme", "bootstrap" );

  var urlParams = new URLSearchParams(window.location.search);
  var code = urlParams.get('code')
  if(code == null){
    splash_page();
  } else{
    $.ajax({
      url: 'api/v1/res?uuid=' + code,
      type: "GET",
      dataType: "json",

      success: function (data){
        if(data.length == 0){
          var ex_type = 'closeness'
        } else{
          var ex_type = 'elo'
        }

        pre_survey(code, ex_type)
      }
    })
  }

  $('#login_toggle').click(function(){
    admin_splash()
  })

  //admin page
  function admin_splash(){
    $.ajax({
      url: 'api/user/',
      type: "GET",
      beforeSend: function(xhr){
        if(localStorage.token){
          xhr.setRequestHeader('Authorization', 'Bearer ' + localStorage.token)
        }
      },

      success: function (data){
        $("#login_toggle").remove()
        $("#logout").remove()
        $("#user_manager").remove()
        $("#exp_manager").remove()
        $("#prog_tracker").remove()
        $("#results_manager").remove()

        $(".navbar").append("<a class='navbar-item navbar-right' id='logout' href='#'>Logout</a>")
        $(".navbar").append('<a class="nav-link navbar-brand" id="user_manager" href="#" style="font-size:1rem;padding-left: 30px">User Manager</a>')
        $(".navbar").append('<a class="nav-link navbar-brand" id="exp_manager" href="#" style="font-size:1rem;padding-left: 0px">Experiment Manager</a>')
        $(".navbar").append('<a class="nav-link navbar-brand" id="prog_tracker" href="#" style="font-size:1rem;padding-left: 0px">Progress Tracker</a>')
        $(".navbar").append('<a class="nav-link navbar-brand" id="results_manager" href="#" style="font-size:1rem;padding-left: 0px">Results</a>')
        $("#logout").click(function(){
          localStorage.removeItem('token')
          user_view()
        })

        //listen for button presses in header -- need smarter way to do this, isn't working because everything routes back through splash again
        $("#user_manager").click(function(){
          user_view()
        })
        $("#exp_manager").click(function(){
          experiment_view()
        })
        $("#prog_tracker").click(function(){
          progress_view()
        })

        user_view()
      },
      error: function (data){
        $('.main').html(`
          <div class = 'content'>
            <h2>Admin Login</h2>

            <div class="input-group mb-3">
              <input type="text" class="form-control" id="admin_id" placeholder="Username">
            </div>
            <div class="input-group mb-3">
              <input type="password" class="form-control" id="password" placeholder="Password">
              <div class="input-group-append">
              </div>
            </div>
            <div class="input-group mb-3">
              <button id = "login_btn" class="btn btn-secondary" type="submit" style='width:100%;'>Log in</button>
            </div>

            <div class="alert alert-danger" id = "alert-badpass" role="alert">
              Invalid username or password.
            </div>
          </div>
        `)
        $('#alert-badpass').hide()
        $('input').on('keypress', (event)=> {
            if(event.which === 13){
                $('#login_btn').click();
            }
        });

        $("#login_btn").click(function() {
          var user = $("#admin_id").val()
          var password = $("#password").val()

          $.ajax({
            url: 'api/token/',
            type: "POST",
            data: {username:user, password:password},

            success: function (data){
              access_token = data.access
              refresh_token = data.refresh

              localStorage.token = data.access
              $("#login_toggle").remove()
              $("#login_toggle").remove()
              $("#logout").remove()
              $("#user_manager").remove()
              $("#exp_manager").remove()
              $("#prog_tracker").remove()
              $("#results_manager").remove()

              $(".navbar").append("<a class='navbar-item navbar-right' id='logout' href='#'>Logout</a>")
              $(".navbar").append('<a class="nav-link navbar-brand" id="user_manager" href="#" style="font-size:1rem;padding-left: 30px">User Manager</a>')
              $(".navbar").append('<a class="nav-link navbar-brand" id="exp_manager" href="#" style="font-size:1rem;padding-left: 0px">Experiment Manager</a>')
              $(".navbar").append('<a class="nav-link navbar-brand" id="prog_tracker" href="#" style="font-size:1rem;padding-left: 0px">Progress Tracker</a>')
              $(".navbar").append('<a class="nav-link navbar-brand" id="results_manager" href="#" style="font-size:1rem;padding-left: 0px">Results</a>')
              $("#logout").click(function(){
                localStorage.removeItem('token')
                user_view()
              })

              //listen for button presses in header
              $("#user_manager").click(function(){
                user_view()
              })
              $("#exp_manager").click(function(){
                experiment_view()
              })
              $("#prog_tracker").click(function(){
                progress_view()
              })

              user_view()
            },
            error: function (data){
              $('#alert-badpass').show()
            }
          })
        })
      }
    })
  }

  function results_view(){
    $('.main').html(`
      <div class = 'content'>
        <h2>Results</h2>
        <p>This page allows you to see the results of all of your experiments.</p>
        <br>
        <div id = 'completed_exps'>
          <h3>Completed Experiments</h3>
        </div>
      </div>

      <button id = "open_user_modal" onclick = "return false;" class="invisible btn btn-dark" type="button" style='width:25%;' data-toggle="modal" data-target="#user_comp_modal" >Open Modal</button>

      <!-- Modal -->
      <div class="modal fade" id="user_comp_modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="exampleModalLongTitle">User Progress Tracker</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body" id='user_modal_cards'>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-dark" data-dismiss="modal">close</button>
            </div>
          </div>
        </div>
      </div>

    `)
  }


  function progress_view(){
    $('.main').html(`
      <div class = 'content'>
        <h2>Progress Tracker</h2>
        <p>This page allows you to see the progress of all of your experiments.</p>
        <br>
        <div id = 'inprogress_exps'>
          <h3>In-Progress Experiments</h3>
        </div>
        <br>
        <div id = 'completed_exps'>
          <h3>Completed Experiments</h3>
        </div>
      </div>

      <button id = "open_user_modal" onclick = "return false;" class="invisible btn btn-dark" type="button" style='width:25%;' data-toggle="modal" data-target="#user_comp_modal" >Open Modal</button>

      <!-- Modal -->
      <div class="modal fade" id="user_comp_modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="exampleModalLongTitle">User Progress Tracker</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body" id='user_modal_cards'>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-dark" data-dismiss="modal">close</button>
            </div>
          </div>
        </div>
      </div>

    `)

    $.ajax({
      url: 'api/v1/exp_internal/',
      type: "GET",
      dataType: "json",
      beforeSend: function(xhr){
        if(localStorage.token){
          xhr.setRequestHeader('Authorization', 'Bearer ' + localStorage.token)
        }
      },

      success: function (data){

        let ids = data.map(a => a.id);

        $.ajax({
        url: 'api/v1/get_progress_internal/',
        type: "POST",
        data: {ids:ids},
        beforeSend: function(xhr){
          if(localStorage.token){
            xhr.setRequestHeader('Authorization', 'Bearer ' + localStorage.token)
          }
        },

          success: function (data_2, textStatus, xhr){
            for(i = 0; i < data.length; i++){
              let id = data[i].id
              let title = data[i].title
              let body = data[i].question
              let date = data[i].date
              let creator = data[i].creator
              let per_complete = data_2[i]
              var mycard = `
              <div class="card" data = ${id}>
                <div class="card-body">
                  <h5 class="card-title">${title}</h5>
                  <p>Date Created: ${date}</p>
                  <p>Created By: ${creator}</p>
                  <p>Question: ${body}</p>
                  <div class="progress">
                    <div class="progress-bar" role="progressbar" style="width: ${per_complete}%;" aria-valuenow="${per_complete}" aria-valuemin="0" aria-valuemax="100">${per_complete}%</div>
                  </div>
                </div>
              </div>
              `
              if(data_2[i] != 100){
                $("#inprogress_exps").append(mycard)
              } else{
                $("#completed_exps").append(mycard)
              }        
            }

          $(".card").click(function(){     


            u_id = $(this).attr('data')
            $.ajax({
              url: 'api/v1/get_progress_byuser_internal/',
              type: "POST",
              data: {u_id},
              beforeSend: function(xhr){
                if(localStorage.token){
                  xhr.setRequestHeader('Authorization', 'Bearer ' + localStorage.token)
                }
              },

                success: function (data_3, textStatus, xhr){
                  $("#user_modal_cards>.card").remove()
                  console.log(data_3)
                  for(i = 0; i < data_3.length; i++){
                    first = data_3[i].first
                    last = data_3[i].last
                    per = data_3[i].per

                    var mycard = `
                    <div class="card">
                      <div class="card-body">
                        <h5 class="card-title">${first} ${last}</h5>
                        <div class="progress">
                          <div class="progress-bar" role="progressbar" style="width: ${per}%;" aria-valuenow="${per}" aria-valuemin="0" aria-valuemax="100">${per}%</div>
                        </div>
                      </div>
                    </div>
                    `
                    $("#user_modal_cards").append(mycard)
                  }
                  $("#open_user_modal").click()
                }
              })
            })
          }
        })
      }
    })
  }



  //what happens when you click on "experiment manager"
  function experiment_view(){
    //basic html including placeholders for the table and the edit/delete modals
    $('.main').html(`
      <div class = 'content'>
        <h2>Experiment Manager</h2>
        <br>
        <p>This page allows you to add and delete experiments.</p>
        <button id = "add_exp" onclick = "return false;" class="btn btn-dark" type="button" style='width:25%;' data-toggle="modal" data-target="#exp_modal" >Add Experiment</button>
        <button id = "view_users" onclick = "return false;" class="invisible btn btn-dark" type="button" style='width:0%;' data-toggle="modal" data-target="#view_exp_modal" ></button>
        <br>
        <br>
        <br>
        <table id="exp_table" class="display nowrap table compact" style="width:100%">
            <thead>
                <tr>
                    <th>Title</th>
                    <th>Creator</th>
                    <th># Participants</th>
                    <th>Question</th>
                    <th>Users</th>
                    <th>Delete</th>
                </tr>
            </thead>
        </table>
      </div>

      <!-- Modal -->
      <div class="modal fade" id="view_exp_modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="exampleModalLongTitle">View Experiment Users</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
            <table id="user_code_table" class="display nowrap table compact" style="width:100%">
              <thead>
                <tr>
                  <th>Rank</th>
                  <th>First</th>
                  <th>Last</th>
                  <th>Email</th>
                  <th>Access Code</th>
                </tr>
              </thead>
            </table>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-dark" data-dismiss="modal">close</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal -->
      <div class="modal fade" id="exp_modal" tabindex="-1" role="dialog" aria-labelledby="expModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="exampleModalLabel">Add an Experiment</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
            <div class = 'content'>
              <form>
                <div class="form-group col-md-12 required">
                  <label class = 'control-label' for="title">Title</label>
                  <input type="text" class="form-control" id="title" placeholder="" required = 'required'>
                </div>
                <div class="form-group col-md-12 required">
                  <label class = 'control-label' for="creator">Creator</label>
                  <input type="text" class="form-control" id="creator" placeholder="">
                </div>
                <div class="form-group col-md-12 required">
                  <label class = 'control-label' for="question">Question</label>
                  <input type="text" class="form-control" id="question" placeholder="">
                </div>
                <div class="form-group col-md-12 required">
                  <label class = 'control-label' for="my-select">Select Users</label>
                  <center>
                    <select id='user_search' multiple='multiple'>
                    </select>
                  </center>
                </div>
                <input type="text" class="form-control" id="id" placeholder="id">
                <div class="form-group col-md-12">
                  <button id = "add_exp_db" onclick = "return false;" class="btn btn-dark" type="button" style='width:100%;'>Add Experiment</button>
                </div>
              </form>
              <div class="alert alert-danger" id = "alert-req" role="alert"> Please provide all required information </div>
              <div class="alert alert-danger" id = "alert-user-req" role="alert"> Must select 3 or more users</div>
              <div class="alert alert-success" id = "alert-success" role="success"> Experiment added successfully </div>
              <div class="alert alert-danger" id = "alert-dup" role="alert"> Experiment with this name already exists </div>
            </div>
            <div class="modal-footer">
            </div>
          </div>
        </div>
      </div>
    `)


    //hide all of the alerts by default (these are in the modals)
    $('#id').hide()
    $('#alert-req').hide()
    $('#alert-success').hide()
    $('#alert-dup').hide()
    $('#alert-user-req').hide()

    //setup tables - one for main page, one for users in the edit screens
    t = $('#exp_table').DataTable({
        language: {
            searchPanes: {
                emptyPanes: 'There are no experiments to display. :/'
            }
        },
        "bSortClasses": false
    });

    t2 = $('#user_code_table').DataTable({
        language: {
            searchPanes: {
                emptyPanes: 'There are no users to display. :/'
            }
        },
        "bSortClasses": false,
        dom: 'Bfrtip',
        buttons: [{
          extend: "csv",
          text: "Export to CSV"
        }],
    });

    //on load, load experiments into the table using GET request to API
    $.ajax({
      url: 'api/v1/exp_internal/',
      type: "GET",
      dataType: "json",
      beforeSend: function(xhr){
        if(localStorage.token){
          xhr.setRequestHeader('Authorization', 'Bearer ' + localStorage.token)
        }
      },

      success: function (data){
        //clear old stuff from table and populate it
        t.clear()
        for(var i = 0; i < data.length; i++){
          t.row.add([data[i].title, data[i].creator, data[i].names.length, data[i].question,'<button id = "delete_btn" data='+data[i].id+' onclick = "return false;" class="btn btn-light show_users_btn btn-sm" type="button" ><i class="bi bi-box-arrow-up-right"></i></button>',
          '<button id = "delete_btn" data='+data[i].id+' onclick = "return false;" class="btn btn-danger delete_btn btn-sm" type="button" ><i class="bi bi-trash"></i></button>']).draw()
        }

        //setup listener that takes action when edit button is pressed - have to do this after the buttons
        //are created in the above loop.
        //hits API to get users associated with the experiment and loads them into a table
        $(".show_users_btn").click(function(){
          $('#view_users').click()
          var exp_id = $(this).attr('data')
          $.ajax({
            url: 'api/v1/user_code_view/',
            type: 'POST',
            data: {exp_id:exp_id},
            beforeSend: function(xhr){
              if(localStorage.token){
                xhr.setRequestHeader('Authorization', 'Bearer ' + localStorage.token)
              }
            },
            success: function(data){
              t2.clear()
              for(var i = 0; i < data.length; i++){
                t2.row.add([data[i][0], data[i][1], data[i][2], data[i][3], data[i][4]]).draw()
              }
            }
          })
        })

        //same idea as edit buttons - use API to delete an experiment when button is clicked
        //if successful, this reloads the experiment manager page to reflect updated table
        $(".delete_btn").click(function(){
          var id = $(this).attr('data')
          $.ajax({
            url: 'api/v1/delete_exp_internal/',
            type: "POST",
            data: {id:id},
            beforeSend:function(xhr){
              if(localStorage.token){
                xhr.setRequestHeader('Authorization', 'Bearer ' + localStorage.token)
              }
              return confirm("Are you sure you want to delete this experiment?");
            },
            success: function (data){
              experiment_view()
            }
          })
        })
      }
    })



    //hit API to load up users that we can add to the experiments
    //only do this when someone clicks to add an experiment
    $("#add_exp").click(function(){
      $.ajax({
        url: 'api/v1/people_internal/',
        type: "GET",
        dataType: "json",
        beforeSend: function(xhr){
          if(localStorage.token){
            xhr.setRequestHeader('Authorization', 'Bearer ' + localStorage.token)
          }
        },
        success: function(data) {
          for(i=0; i < data.length; i++){
            var nice_name = data[i].rank + ' ' + data[i].first + ' ' + data[i].last
            $('#user_search').append("<option data = "+data[i].id+" value='" + nice_name + "'>" + nice_name + "</option>")
          }

          $('#user_search').multiSelect({
            selectableHeader: "<input type='text' class='search-input' autocomplete='off' placeholder='Type to Search'>",
            selectionHeader: "<input type='text' class='search-input' autocomplete='off' placeholder='Type to Search'>",
            selectableFooter: "<div class='custom-header'>Available Users</div>",
            selectionFooter: "<div class='custom-header'>Selected Users</div>",
            afterInit: function(ms){
              var that = this,
                  $selectableSearch = that.$selectableUl.prev(),
                  $selectionSearch = that.$selectionUl.prev(),
                  selectableSearchString = '#'+that.$container.attr('id')+' .ms-elem-selectable:not(.ms-selected)',
                  selectionSearchString = '#'+that.$container.attr('id')+' .ms-elem-selection.ms-selected';

              that.qs1 = $selectableSearch.quicksearch(selectableSearchString)
              .on('keydown', function(e){
                if (e.which === 40){
                  that.$selectableUl.focus();
                  return false;
                }
              });

              that.qs2 = $selectionSearch.quicksearch(selectionSearchString)
              .on('keydown', function(e){
                if (e.which == 40){
                  that.$selectionUl.focus();
                  return false;
                }
              });
            },
            afterSelect: function(){
              this.qs1.cache();
              this.qs2.cache();
            },
            afterDeselect: function(){
              this.qs1.cache();
              this.qs2.cache();
            }
          });
        }
      })
    })
    

    //when "add experiment" button pressed in modal, create the experiment with a POST request to API
    //if successful, reload the experiment manager, otherwise show the correct error
    //note: i use status 201 and 202 to prompt the user if they didn't provide all required fields or if they
    //didn't provide enough users, respectively.  The 500 error that triggers the error() function is for duplicate
    //titles, which aren't allowed.
    $("#add_exp_db").click(function() {
      var title = $("#title").val()
      var creator = $("#creator").val()
      var names = $(".ms-selection>.ms-list>.ms-selected").map(function(){return $(this).attr('data')}).get()
      var question = $("#question").val()
      var email = $("#email").val()

      $.ajax({
        url: 'api/v1/add_exp_internal/',
        type: "POST",
        data: {title:title, creator:creator, names:names, question:question, email:email},
        beforeSend: function(xhr){
          if(localStorage.token){
            xhr.setRequestHeader('Authorization', 'Bearer ' + localStorage.token)
          }
        },

        success: function (data, textStatus, xhr){
          if(xhr.status == 201){
            $('#alert-req').hide()
            $('#alert-success').hide()
            $('#alert-dup').hide()
            $('#alert-user-req').hide()
            $('#alert-req').show()
            $('#alert-req').delay(2500).fadeOut('slow')

          } else if(xhr.status == 202){
            $('#alert-req').hide()
            $('#alert-success').hide()
            $('#alert-dup').hide()
            $('#alert-user-req').show()
            $('#alert-req').hide()
            $('#alert-user-req').delay(2500).fadeOut('slow')

          } else{
            $('#alert-req').hide()
            $('#alert-success').hide()
            $('#alert-dup').hide()
            $('#alert-user-req').hide()
            $('#alert-success').show()
            $('.close').click()
            $(".modal-fade").modal("hide");
            $(".modal-backdrop").remove();
            experiment_view()
          }
        },
        error: function (data){
          $('#alert-req').hide()
          $('#alert-success').hide()
          $('#alert-dup').hide()
          $('#alert-user-req').hide()
          $('#alert-dup').show()
          $('#alert-dup').delay(5000).fadeOut('slow')
        }
      })
    })
  }


  //create the user view when "User Manager" is clicked
  function user_view(){
    //this is the scaffolding for everything that we'll generate.  similar to experiment view above.
    $('.main').html(`
      <div class = 'content'>
        <h2>User Manager</h2>
        <br>
        <p>This page allows you to add new users via form or bulk upload as well as edit and delete existing users.</p>
        <button id = "add_user_form" onclick = "return false;" class="btn btn-dark" type="button" style='width:25%;' data-toggle="modal" data-target="#exampleModal" >Add New User</button>
        <br>
        <br>
        <br>
        <table id="example" class="display nowrap table compact" style="width:100%">
            <thead>
                <tr>
                    <th>First Name</th>
                    <th>Middle Name</th>
                    <th>Last Name</th>
                    <th>Rank</th>
                    <th>Email</th>
                    <th>Edit</th>
                    <th>Delete</th>
                </tr>
            </thead>
        </table>
      </div>

      <!-- Modal -->
      <div class="modal fade" id="delete_modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="exampleModalLongTitle">Delete User</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              Are you sure you want to delete this user?
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-dark" data-dismiss="modal">Cancel</button>
              <button type="button" class="btn btn-danger">Delete</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal -->
      <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="exampleModalLabel">Add a User</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
            <div class = 'content'>
              <form>
                <div class="form-group col-md-12 required">
                  <label class = 'control-label' for="first_name">First Name</label>
                  <input type="text" class="form-control" id="first_name" placeholder="" required = 'required'>
                </div>
                <div class="form-group col-md-12">
                  <label for="middle_name">Middle Name</label>
                  <input type="text" class="form-control" id="middle_name" placeholder="">
                </div>
                <div class="form-group col-md-12 required">
                  <label class = 'control-label' for="last_name">Last Name</label>
                  <input type="text" class="form-control" id="last_name" placeholder="">
                </div>
                <div class="form-group col-md-12 required">
                  <label class = 'control-label' for="rank_select">Rank</label>
                  <select class="form-control" id="rank_select">
                    <option>PVT</option>
                    <option>PV2</option>
                    <option>PFC</option>
                    <option>SPC</option>
                    <option>CPL</option>
                    <option>SGT</option>
                    <option>SSG</option>
                    <option>SFT</option>
                    <option>MSG</option>
                    <option>1SG</option>
                    <option>SGM</option>
                    <option>2LT</option>
                    <option>1LT</option>
                    <option selected>CPT</option>
                    <option>MAJ</option>
                    <option>LTC</option>
                    <option>COL</option>
                  </select>
                </div>
                <div class="form-group col-md-12 required">
                  <label class = 'control-label' for="email">Email address</label>
                  <input type="email" class="form-control" id="email" aria-describedby="emailHelp" placeholder="">
                </div>
                <input type="text" class="form-control" id="id" placeholder="id">
                <div class="form-group col-md-12">
                  <button id = "add_user" onclick = "return false;" class="btn btn-dark" type="button" style='width:100%;'>Add User</button>
                </div>
              </form>
              <div class="alert alert-danger" id = "alert-req" role="alert"> Please provide all required information </div>
              <div class="alert alert-success" id = "alert-success" role="success"> User added successfully </div>
              <div class="alert alert-danger" id = "alert-dup" role="alert"> User already exists </div>
            </div>
            <div class="modal-footer">
            </div>
          </div>
        </div>
      </div>
    `)

    //binds enter key to the button in the modal
    $('input').on('keypress', (event)=> {
        if(event.which === 13){
            $('#add_user').click();
        }
    });

    $('#id').hide()

    //setup table
    t = $('#example').DataTable({
        language: {
            searchPanes: {
                emptyPanes: 'There are no users to display. :/'
            }
        },
        "bSortClasses": false
    });

    $('#alert-req').hide()
    $('#alert-success').hide()
    $('#alert-dup').hide()
    //need to reset these in case they were set by an edit
    $('#add_user_form').click(function(){
      $('#first_name').val('')
      $('#middle_name').val('')
      $('#last_name').val('')
      $('#rank_select').val('')
      $('#email').val('')
      $('#id').val('')
    })

    //make GET request to get the users already in the database, populate table
    $.ajax({
      url: 'api/v1/people_internal/',
      type: "GET",
      dataType: "json",
      beforeSend: function(xhr){
        if(localStorage.token){
          xhr.setRequestHeader('Authorization', 'Bearer ' + localStorage.token)
        }
      },

      success: function (data){
        for(var i = 0; i < data.length; i++){
          t.row.add([data[i].first, data[i].middle, data[i].last, data[i].rank, data[i].email, '<button id = "edit_btn" data = '+data[i].id+' onclick = "return false;" class="edit_btn btn btn-dark btn-sm" type="button"><i class="bi bi-pencil"></i></button>',
        '<button id = "delete_btn" data='+data[i].id+' " onclick = "return false;" class="btn btn-danger delete_btn btn-sm" type="button"><i class="bi bi-trash"></i></button>']).draw()
        }

        //when edit button pressed, load all relevant data into the form and open it
        $('.edit_btn').click(function(){
          var this_button = data.filter(x => x.id == $(this).attr('data'))[0]
          $('#add_user_form').click()
          $('#first_name').val(this_button.first)
          $('#middle_name').val(this_button.middlle)
          $('#last_name').val(this_button.last)
          $('#rank_select').val(this_button.rank)
          $('#email').val(this_button.email)
          $('#id').val(this_button.id)
        })

        //make POST request to delete user on click, reload user manager
        $(".delete_btn").click(function(){
          var id = $(this).attr('data')
          $.ajax({
            url: 'api/v1/delete_people_internal/',
            type: "POST",
            data: {id:id},
            beforeSend:function(xhr){
              if(localStorage.token){
                xhr.setRequestHeader('Authorization', 'Bearer ' + localStorage.token)
              }
              return confirm("Are you sure you want to delete this user?");
            },
            success: function (data, textStatus, xhr){
              if(xhr.status == 201){
                alert("Cannot delete user that is in one or more Experiment(s).  Please delete any Experiments involving this user before trying to delete them.")
              } else{
                user_view()
              }
            }
          })
        })
      }
    })

    //hit API with POST request when user add form is filled out
    //using 201 code to prompt that not enough all required fields provided
    //if successful, reload page
    $("#add_user").click(function() {
      var first = $("#first_name").val()
      var middle = $("#middle_name").val()
      var last = $("#last_name").val()
      var rank = $("#rank_select").val()
      var email = $("#email").val()
      var id = $("#id").val()

      $.ajax({
        url: 'api/v1/add_people_internal/',
        type: "POST",
        data: {first:first, middle:middle, last:last, rank:rank, email:email, id:id},
        beforeSend: function(xhr){
          if(localStorage.token){
            xhr.setRequestHeader('Authorization', 'Bearer ' + localStorage.token)
          }
        },

        success: function (data, textStatus, xhr){
          if(xhr.status == 201){
            $('#alert-req').hide()
            $('#alert-success').hide()
            $('#alert-dup').hide()
            $('#alert-req').show()
            $('#alert-req').delay(2500).fadeOut('slow')

          } else{
            $('form').get(0).reset()
            $('#alert-req').hide()
            $('#alert-success').hide()
            $('#alert-dup').hide()
            $('#alert-success').show()
            $('#alert-success').delay(2500).fadeOut('slow')
            $(".modal-fade").modal("hide");
            $(".modal-backdrop").remove();
            user_view()
          }
        },
        error: function (data){
          $('#alert-req').hide()
          $('#alert-success').hide()
          $('#alert-dup').hide()
          $('#alert-dup').show()
          $('#alert-dup').delay(2500).fadeOut('slow')
        }
      })
    })
  }

  //main page that asks for access code
  function splash_page(){
    $('.main').html(`
      <div class = 'content'>
        <h2>Please Enter Your Access Code</h2>

        <div class="input-group mb-3">
          <input type="text" class="form-control" id="password" placeholder="Enter Access Code">
          <div class="input-group-append">
            <button id = "start_exp" onclick = "return false;" class="btn btn-secondary" type="button">Start</button>
          </div>
        </div>
        <div class="alert alert-danger" id = "alert-blank" role="alert">
            Please fill out all required fields
        </div>
        <div class="alert alert-danger" id = "alert-invalid" role="alert">
          Invalid access code
        </div>
      </div>
    `)
    $('#alert-blank').hide()
    $('#alert-invalid').hide()
  }

  //page with some instructions
  //if user doesn't have any ratings left to do, just push them to thank you page
  function pre_survey(access_code, ex_type){
    $.ajax({
      url: 'api/v1/res?uuid=' + access_code,
      type: "GET",
      dataType: "json",

      success: function (data){
        if(data.length > 0){
          $('.main').html(`
            <div class = 'content'>
              <h2>Pre-Survey Instructions</h2>
                <p>This peer evaluation will ask you to provide feedback to your squadmates. Please be honest and professional with your ratings.</p>

              <button id = "start_exp_now" onclick = "return false;" class="btn btn-secondary" type="button">I Understand</button>
            </div>
            <div id="overlay" style="display:none;">
              <div class="spinner"></div>
            </div>
          `)
          $("#start_exp_now").click(function() {
            $('#overlay').fadeIn()
            update_pair(access_code)
          });
        } else{
          $('.main').html(`
            <div class = 'content'>
              <h2>Your ratings have been captured - thank you!</h2>
            </div>
          `)
        }
      }
    });
  }

  //pull the question defined when experiment was created
  function get_question(exp_id){
    $.ajax({
      url: 'api/v1/exp?exp_id=' + exp_id,
      type: "GET",
      dataType: "json",

      success: function (data){
        $('#question').text(data[0].question)
        $('#overlay').fadeOut()
      }
    })
  }


//hit api to get one of the remaining pairs for a rater
function update_pair(access_code){
  $.ajax({
    url: 'api/v1/res?uuid=' + access_code,
    type: "GET",
    dataType: "json",

    success: function (data){

      if(data == ''){
        $.ajax({
          url: 'api/v1/res_closeness?uuid=' + access_code,
          type: "GET",
          dataType: "json",

          success: function (data){
            //if none left, kick to thank you page
            if(data.length == 0){
              $('#overlay').fadeOut()
              $('.main').html(`
                <div class = 'content'>
                  <h2>Your ratings have been captured - thank you!</h2>
                </div>
              `)
            } else{
              $('.main').html(`
              <div class = 'content'>
                <h4 id = 'num_left'></h4>
                <h4>Select the pair of circles that best describes your relationship with: <br><span id = 'question' style = 'color: red'></span></h4>
                <div class="row justify-content-center">
                  <div class="col-xs" id = 'spec_col'>
                    <div class="card">
                    <img id = '01' class="card-img-top img-responsive" src = "{% static 'frontend/img/01_alt.png' %}">
                    </div>
                  </div>
                  <div class="col-xs" id = 'spec_col'>
                    <div class="card">
                    <img id = '02' class="card-img-top img-responsive" src = "{% static 'frontend/img/02_alt.png' %}">
                    </div>
                  </div>
                </div>
                <div class="row justify-content-center">
                  <div class="col-xs" id = 'spec_col'>
                    <div class="card">
                    <img id = '03' class="card-img-top img-responsive" src = "{% static 'frontend/img/03_alt.png' %}">
                    </div>
                  </div>
                  <div class="col-xs" id = 'spec_col'>
                    <div class="card">
                    <img id = '04' class="card-img-top" src = "{% static 'frontend/img/04_alt.png' %}">
                    </div>
                  </div>
                </div>
                <div class="row justify-content-center">
                  <div class="col-xs" id = 'spec_col'>
                    <div class="card">
                    <img id = '05' class="card-img-top" src = "{% static 'frontend/img/05_alt.png' %}">
                    </div>
                  </div>
                  <div class="col-xs" id = 'spec_col'>
                    <div class="card">
                    <img id = '06' class="card-img-top" src = "{% static 'frontend/img/06_alt.png' %}">
                    </div>
                  </div>
                </div>
              </div>
              <div id="overlay" style="display:none;">
                <div class="spinner"></div>
              </div>

            `)

            $("#question").text(data[0].name.rank + ' ' + data[0].name.first + ' ' + data[0].name.last)

            $('#overlay').fadeOut()

            //get timestamp when viewer first sees pair
            start = Date.now()

            //handle clicks on names
            $('.card-img-top').click(function(){
              $('#overlay').fadeIn()
              $(window).scrollTop(0);
              end = Date.now()
              add_closeness_rating(data[0], data[0].name, this.id, start, end, access_code)
              //add_rating(data[0], data[0].name_1, start, end, access_code)
            });
          }
        }
      })
    } else if(data.length == 0){
      $('#overlay').fadeOut()
      go_to_comments(access_code)
    } else{
      $('.main').html(`
      <div class = 'content'>
        <h4 id = 'num_left'></h4>
        <br>
        <h2 id = 'question'></h2>
        <br><br>
        <div class="row">
          <div class="col-sm-6">
            <div class="card" id = 'name1_card'>
              <div class="card-body">
                <center><h4 class="card-title stretched-link" id = 'name1'></h4></center>
              </div>
            </div>
          </div>
          <div class="col-sm-6">
            <div class="card" id = 'name2_card'>
              <div class="card-body">
                <center><h4 class="card-title" id = 'name2'></h4></center>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div id="overlay" style="display:none;">
        <div class="spinner"></div>
      </div>
    `)

    var index = Math.floor(Math.random() * data.length)
    get_question(data[index].experiment_name)

    //get timestamp when viewer first sees pair
    start = Date.now()

    //set names according to data
    //could speed up by only returning a single object, but this shouldn't be measurably different


    if(Math.round(Math.random()) == 0){
      $('#name1').text(data[index].name_1.first + ' ' + data[index].name_1.last)
      $('#name2').text(data[index].name_2.first + ' ' + data[index].name_2.last)

      //handle clicks on names
      $('#name1_card').click(function(){
        $('#overlay').fadeIn()
        end = Date.now()
        add_rating(data[index], data[index].name_1, start, end, access_code)
      });

      $('#name2_card').click(function(){
        $('#overlay').fadeIn()
        end = Date.now()
        add_rating(data[index], data[index].name_2, start, end, access_code)
      });


    } else{
      $('#name2').text(data[index].name_1.first + ' ' + data[index].name_1.last)
      $('#name1').text(data[index].name_2.first + ' ' + data[index].name_2.last)

      //handle clicks on names
      $('#name1_card').click(function(){
        $('#overlay').fadeIn()
        end = Date.now()
        add_rating(data[index], data[index].name_2, start, end, access_code)
      });

      $('#name2_card').click(function(){
        $('#overlay').fadeIn()
        end = Date.now()
        add_rating(data[index], data[index].name_1, start, end, access_code)
      });
    }

    //set matches remaining counter
    $('#num_left').text('Matches Remaining: ' + data.length)



    //handle arrow keys - just automate clicking process
    $(document).keydown(function(e) {
      switch(e.which) {
        case 37: // left
          $('#name1_card').click()
        break;

        case 38: // up
        break;

        case 39: // right
          $('#name2_card').click()
        break;

        default: return; // exit this handler for other keys
      }

      e.preventDefault(); // prevent the default action (scroll / move caret)
    });
  }

    }
  })
}

//listen for uuid to start the whole process
$(document).ready(function() {
  $("#start_exp").click(function() {

    $('#alert-blank').hide()
    $('#alert-invalid').hide()


    if($("#password").val().length > 0){

      $.ajax({
        url: 'api/v1/res?uuid=' + $("#password").val(),
        type: "GET",
        dataType: "json",

        success: function (data){

          if(data.length == 0){

            $.ajax({
              url: 'api/v1/res_closeness?uuid=' + $("#password").val(),
              type: "GET",
              dataType: "json",
              success: function(data){
                var ex_type = 'closeness'
                //pre_survey($("#password").val(), ex_type);
                update_pair($("#password").val())
              },
              error: function(data){
                $('#alert-invalid').show()
              }
            })
          } else{
            var ex_type = 'elo'
            //pre_survey($("#password").val(), ex_type);
            update_pair($("#password").val())
          }
        },
        error: function(){
          $('#alert-invalid').show()
        }

      })

    } else{
      $('#alert-blank').show()
    }
  });
});


  //push the selection back to server
  function add_rating(dat, winner, start_time, end_time, access_code){
    //make sure the csrf token is passed along...should satisfy django security
    function getCookie(name) {
      var cookieValue = null;
      if (document.cookie && document.cookie != '') {
          var cookies = document.cookie.split(';');
          for (var i = 0; i < cookies.length; i++) {
              var cookie = jQuery.trim(cookies[i]);
              // Does this cookie string begin with the name we want?
              if (cookie.substring(0, name.length + 1) == (name + '=')) {
                  cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                  break;
              }
          }
      }
      return cookieValue;
      }
    var csrftoken = getCookie('csrftoken');
    function csrfSafeMethod(method) {
       return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }
    $.ajaxSetup({
        beforeSend: function(xhr, settings) {
           if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
               xhr.setRequestHeader("X-CSRFToken", csrftoken);
         }
      }
    });

    //actually send the request with relevant info
    $.ajax({
      url: 'api/v1/add_rating/',
      data:{
        id: dat.id,
        winner: winner.id,
        start_time: start_time,
        end_time: end_time
      },
      type: 'POST',
      content_type: 'application/json',
      success: function (){
        //console.log('done!')

        //trigger reload of the main pairs page - will automatically pull next pair
        update_pair(access_code)
      }
    })
  }



  </script>
  </body>
</html>
